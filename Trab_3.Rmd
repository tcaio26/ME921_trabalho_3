---
title: "R Notebook"
output: html_notebook
---

```{r setup}
#setwd('/home/caio_theodore/Documents/r_data/ME912/Trab_3')

library(pacman)
p_load(tidyverse)


```

```{r dados}
got_edges = read_csv('asoiaf-all-edges.csv') %>% select(-3) #weight é numero de interações
got_nodes = read_csv('asoiaf-all-nodes.csv')
```

```{r tratamento e redução}
# got_nodes$house = case_when(got_nodes$Label,)

characters_intercations = rbind(rename(got_edges[,c(1,4)], char = Source),rename(got_edges[,c(2,4)], char = Target)) %>% 
  group_by(char) %>% summarise(interactions = sum(weight))

chars_reduzido = characters_intercations %>% filter(interactions>=100) %>% pull(char)

got_edges_r = got_edges %>% filter(Source%in% chars_reduzido & Target %in% chars_reduzido)
got_nodes_r = got_nodes %>% filter(Id%in% chars_reduzido)

n = nrow(got_nodes_r)
```

```{r funções}
#fun_diff = function(elements, indices, positions)
```

```{r matrizes}
X = Y = matrix(0, nrow = n, ncol = n, dimnames = list('n1' = chars_reduzido, 'n2' = chars_reduzido))
for(i in 1:n){
  for(j in i:n){
    if(nrow(filter(got_edges_r, (Source==chars_reduzido[i]& Target==chars_reduzido[j])|(Source==chars_reduzido[j]& Target==chars_reduzido[i])))==0){
      X[i,j]=X[j,i]=0
      Y[i,j]=Y[j,i]=0
    }
    if(nrow(filter(got_edges_r, (Source==chars_reduzido[i]& Target==chars_reduzido[j])|(Source==chars_reduzido[j]& Target==chars_reduzido[i])))==1){
      wt = filter(got_edges_r, (Source==chars_reduzido[i]& Target==chars_reduzido[j])|(Source==chars_reduzido[j]& Target==chars_reduzido[i])) %>% pull(weight)
      X[i,j]=X[j,i]=1
      Y[i,j]=Y[j,i]=wt
    }
  }
}
```

```{r heatmap}
heatmap(Y, Rowv = NA, Colv = NA, scale = 'none') #função está omitindo nomes
hist(got_edges_r$weight, breaks = 50)
```

```{r chutes iniciais}
mu = mean(got_edges_r$weight[got_edges_r$weight>0])^(-1)
Q = 4
chutes = sample(1:Q,n,replace = T,theta) #prioris envolvidas: clusters equiprováveis e número Q de clusters
tau0 = c()
for (i in 1:n) {
  tau0 = append(tau0,c(rep(0,chutes[i]-1),1,rep(0,Q-chutes[i])))
}
tau0 = matrix(tau0, nrow = n, byrow = T) #obs j pertence ao cluster i
```

```{r updates função}
update_param = function(X, Y, tau){
  theta = apply(tau, 2, sum)
  for (q in 1:Q) {
    for (l in 1:Q){
      p1 = 0
      p2 = 0
      p3 = 0
      p4 = 0
      p5 = 0
      for (i in 1:n) {
        for (j in 1:n) {
          if(i!=j){
            p2 = p2 + tau[i,q]*tau[j,l]
            if(X[i,j]>0){
              p1 = p1 + tau[i,q]*tau[j,l]*X[i,j]
              p3 = p3 + tau[i,q]*tau[j,l]*X[i,j]*Y[i,j]
              p4 = p4 + tau[i,q]*tau[j,l]*X[i,j]*log(Y[i,j])
              p5 = p5 + tau[i,q]*tau[j,l]*X[i,j]*log(Y[i,j])*Y[i,j]
            }
          }
        }
      }
      pi[q,l] = p1/p2
      alpha[q,l] = (p1*p3)/(p1*p5 - p4*p3)
      beta[q,l] = (p1^2)/(p1*p5 - p4*p3)
    }
  }
  return(list(theta = theta, pi = pi, alpha = alpha, beta = beta))
}

update_tau = function(X, Y, param, tau){
  tau2 = as.matrix(tau)
  theta = param$theta
  pi = param$pi
  alpha = param$alpha
  beta = param$beta
  for(i in 1:n){
    for(q in 1:Q){
      t = 1
      for(j in 1:n){
        for(l in 1:Q){
          if(j!=i & tau[j,l]==1){
            t = t*(theta[q])*(X[i,j]*pi[q,l] + (1-X[i,j])*(1-pi[q,l]))*(dgamma(Y[i,j],alpha[q,l],beta[q,l])^(X[i,j]))
          }
        }
      }
      tau2[i,q] = t
    }
  }
  return(tau2)
}
```

```{r teste função}
param = update_param(X, Y, tau0)
```
